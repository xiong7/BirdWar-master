{"version":3,"sources":["network.js"],"names":["window","network","initNetwork","pomeloBuildObj","pomeloBuild","create","pomelo","isBinding","onMessage","bind","netListener","eventListener","reset","_registerNetEvent","curMsgName","routerManager","dispatch","clientEvent","receiveRouterFromServer","on","route","apply","arguments","getCurMsgName","connect","ip","port","cb","netConfig","host","log","isKicked","wsStr","setTimeout","disconnect","isConnected","guid","s4","Math","floor","random","toString","substring","send","routeStr","dataObj","uuid","console","JSON","stringify","addRouterToManager","msgOrigin","router","cc","error","Object","keys","length","setNetLoadingStatus","flag","checkNetLoadingStatus","keysLength","currentTime","Date","now","key","hasOwnProperty","routerTime","deltaTime","netLoadingCheckInterval","indexOf","index","clearCallback","isConnecting","isOpen","isClosed","isClosing","chooseNetworkMode","msgName","handler","msgContent"],"mappings":"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","file":"network.js","sourceRoot":"../../../../../../../assets/common/script/basic/rankNetwork","sourcesContent":["window.network = {\n    initNetwork: function() {\n        this.pomeloBuildObj = pomeloBuild.create();\n        this.pomelo = this.pomeloBuildObj.pomelo;\n\n        this.isBinding = false;\n\n        if (!this.isBinding) { // 主要为了让onMessage绑定this\n            this.onMessage = this.onMessage.bind(this);\n            this.isBinding = true;\n        }\n\n        // 只能被network用，其他人不能用\n        this.netListener = eventListener.create(\"one\");\n        this.reset();\n        this._registerNetEvent();\n    },\n\n    reset: function() {\n        this.curMsgName = \"\";\n\n        // 路由管理器（暂名）重置，重置后立马刷新一次netLoading的显示\n        this.routerManager = {};\n    },\n    /**\n     内部使用的注册网络回调函数\n     */\n    _registerNetEvent: function() {\n        this.pomelo[\"on\"](\"heartbeat timeout\", function() {\n            this.pomelo[\"disconnect\"]();\n\n            this.netListener.dispatch(\"reconnect timeout\", {});\n        }.bind(this));\n\n        this.pomelo[\"on\"](\"heartbeat recv\", function() {\n            clientEvent.dispatch(\"updateNetworkState\", \"heartBeatRet\");\n        }.bind(this));\n\n        this.pomelo[\"on\"](\"close\", function() {\n            this.pomelo[\"disconnect\"]();\n\n            this.netListener.dispatch(\"network close\", {});\n        }.bind(this));\n\n        this.pomelo[\"on\"](\"onKick\", function() {\n            this.netListener.dispatch(\"kick user\", {});\n\n            // 关闭网络loading动画\n            this.receiveRouterFromServer('close all netLoading');\n        }.bind(this));\n    },\n\n    // 网络协议都是在logic注册的，不能注销\n    on: function(route) {\n        this.netListener.on.apply(this.netListener, arguments);\n        pomelo[\"on\"](route, this.onMessage);\n    },\n\n    getCurMsgName: function() {\n        return this.curMsgName;\n    },\n\n    connect: function(ip, port, cb) {\n        var netConfig = {\n            host: ip,\n            port: port,\n            log: true\n        };\n\n        this.isKicked = false;\n        netConfig.wsStr = \"wss://\";\n\n        // 解决微信上点击会崩溃的bug,网络连接不能在放在ui层,所以用timeout包装一层\n        setTimeout(function() {\n            this.pomelo[\"init\"](netConfig, function() {\n                if (cb) cb();\n            }.bind(this));\n        }.bind(this), 0);\n    },\n\n    disconnect: function() {\n        if (this.isConnected()) {\n            this.pomelo[\"disconnect\"]();\n        }\n    },\n    /**\n     *  globally-unique identifiers, 生成一个不重复的随机字符串，用于跟踪请求链\n     */\n    guid: function() {\n        function s4() {\n            return Math.floor((1 + Math.random()) * 0x10000)\n                .toString(16)\n                .substring(1);\n        }\n\n        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +\n            s4() + '-' + s4() + s4() + s4();\n    },\n\n    send: function(routeStr, dataObj) {\n        if (typeof (dataObj) === \"undefined\") {\n            dataObj = {};\n        }\n\n        // 请求参数中加入唯一标识,用于跟踪请求链。\n        dataObj.uuid = this.guid();\n        console.log(\"send route:\" + routeStr + \" data:\" + JSON.stringify(dataObj));\n\n        // 记录路由请求\n        this.addRouterToManager(routeStr);\n\n        if (this.isConnected()) {\n            this.pomelo[\"request\"](routeStr, dataObj, this.onMessage);\n        }\n    },\n\n    onMessage: function(msgOrigin) {\n        var router = msgOrigin[\"route\"];\n\n        this.receiveRouterFromServer(router);\n\n        console.log(\"receive msg from :\" + JSON.stringify(msgOrigin));\n\n        if (msgOrigin[\"body\"][\"code\"] === 500) {\n            cc.error(\"server data error, can't find the route:\" + router);\n            // pomelo异常处理都返回500，仍然需要做分发处理\n            // return;\n        }\n\n        if (!router) {\n            cc.error(\"please add the msg route in server\");\n            return;\n        }\n\n        // 空数据\n        if (Object.keys(msgOrigin[\"body\"]).length <= 0) {\n            cc.error(\"server data error, can't response no data proto\");\n            return;\n        }\n\n        this.curMsgName = msgOrigin[\"route\"];\n\n        this.netListener.dispatch(msgOrigin[\"route\"], msgOrigin[\"body\"]);\n    },\n\n    setNetLoadingStatus: function(flag) {\n        if (flag) {\n            // clientEvent.dispatch(\"showPanel\", \"netLoadingPanel\");\n        } else {\n            clientEvent.dispatch('hidePanel', \"netLoadingPanel\");\n        }\n    },\n\n    /**\n     * 检测 netLoading 的显示状态\n     * 从 routeManager 中获取每个记录的路由的请求时间，与当前时间对比\n     * 如果超出阈值就显示 netLoading\n     * 注：已返回的路由就会从 routerManager 中删掉\n     */\n    checkNetLoadingStatus: function() {\n        var keys = Object.keys(this.routerManager);\n        var keysLength = keys.length;\n        if (keysLength <= 0) {\n            this.netListener.dispatch('hidePanel', \"netLoadingPanel\");\n            return;\n        }\n\n        var currentTime = Date.now();\n        for (var key in this.routerManager) {\n            if (this.routerManager.hasOwnProperty(key)) {\n                var routerTime = this.routerManager[key];\n                var deltaTime = currentTime - routerTime;\n                if (deltaTime > this.netLoadingCheckInterval) {\n                    // 存在路由的请求时间超出了阈值，显示 netLoading\n                    // 有路由显示的话，就不再检查其他的路由\n                    return;\n                }\n            }\n        }\n    },\n\n    /**\n     * 将路由添加到路由管理器（暂名）\n     * @param {String} router 路由名\n     * 将 { 路由名 => 时间 } 作为键值对存起来，如果是已经存在的路由，则跳过\n     */\n    addRouterToManager: function(router) {\n        var keys = Object.keys(this.routerManager);\n\n        // 断线重连期间，拒绝其他的路由加入\n        if (keys.indexOf('connectTimeout') === -1) {\n            // 断线重连时，清空路由\n            if (router === 'connectTimeout') {\n                this.routerManager = {};\n            }\n\n            keys = Object.keys(this.routerManager);\n            var index = keys.indexOf(router);\n            if (index === -1) {\n                var currentTime = Date.now();\n                this.routerManager[router] = currentTime;\n            }\n        }\n    },\n\n    /**\n     * 收到网络返回，将路由管理器（暂名）中对应的路由删掉\n     * @param {String} router 路由名\n     */\n    receiveRouterFromServer: function(router) {\n        if (router === 'close all netLoading') {\n            this.routerManager = {};\n            this.checkNetLoadingStatus();\n            return;\n        }\n        var keys = Object.keys(this.routerManager);\n        var index = keys.indexOf(router);\n        if (index > -1) {\n            console.log(router, \"cost\", Date.now() - this.routerManager[router], \"ms\");\n            delete this.routerManager[router];\n\n            // 删除之后要刷新一次 netLoading 的显示\n            this.checkNetLoadingStatus();\n        }\n    },\n    /**\n     * 请客网络回调\n     */\n    clearCallback: function() {\n        if (this.pomelo) this.pomelo.clearCallback();\n    }\n};\n\nnetwork.isConnecting = function() {\n    return this.pomelo.isConnecting();\n};\n\nnetwork.isConnected = function() {\n    return this.pomelo.isOpen();\n};\n\nnetwork.isClosed = function() {\n    return this.pomelo.isClosed();\n};\n\nnetwork.isClosing = function() {\n    return this.pomelo.isClosing();\n};\n\nnetwork.chooseNetworkMode = function() {\n    this.initNetwork();\n    if (this.pomelo) {\n        for (var key in this.netListener) {\n            this.pomelo[\"on\"](key, this.onMessage);\n        }\n    }\n};\n\nnetwork.on = function(msgName, handler) {\n    this.netListener.on(msgName, handler);\n};\n\nnetwork.dispatch = function(msgName, msgContent) {\n    this.netListener.dispatch(msgName, msgContent);\n};\n"]}