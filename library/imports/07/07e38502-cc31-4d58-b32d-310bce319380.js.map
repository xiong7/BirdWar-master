{"version":3,"sources":["../../../../../assets/game/script/assets/game/script/bulletManager.js"],"names":["mvs","require","GLB","cc","Class","extends","Component","properties","friendBulletPrefab","default","type","Prefab","enemyBulletPrefab","onLoad","Game","BulletManager","bulletId","friendBulletPool","NodePool","enemyBulletPool","clientEvent","on","eventType","roundStart","scheduleFire","roundOver","clearScheduleFire","gameOver","isRoomOwner","clearInterval","scheduleFireID","console","log","setInterval","GameManager","gameState","GameState","Over","data","j","PlayerManager","players","length","playerScript","getComponent","worldPos","firePoint","convertToWorldSpaceAR","v2","bulletPoint","node","parent","convertToNodeSpaceAR","push","playerId","userId","bulletPointY","y","msg","action","PLAYER_FIRE_EVENT","sendEventEx","bind","fireInterval","spawnBullet","hostPlayer","bulletCnt","curRound","i","bulletObj","camp","Camp","Enemy","get","instantiate","bulletScript","init","recycleBullet","put","onDestroy","off"],"mappings":"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","file":"bulletManager.js","sourceRoot":"../../../../../assets/game/script","sourcesContent":["var mvs = require(\"Matchvs\");\nvar GLB = require(\"Glb\");\ncc.Class({\n\n    extends: cc.Component,\n    properties: {\n        friendBulletPrefab: {\n            default: null,\n            type: cc.Prefab\n        },\n        enemyBulletPrefab: {\n            default: null,\n            type: cc.Prefab\n        }\n    },\n\n    onLoad() {\n        Game.BulletManager = this;\n        this.bulletId = 456489135745;\n        // 子弹池--\n        this.friendBulletPool = new cc.NodePool();\n        this.enemyBulletPool = new cc.NodePool();\n        clientEvent.on(clientEvent.eventType.roundStart, this.scheduleFire, this);\n        clientEvent.on(clientEvent.eventType.roundOver, this.clearScheduleFire, this);\n        clientEvent.on(clientEvent.eventType.gameOver, this.clearScheduleFire, this);\n\n    },\n\n    clearScheduleFire: function() {\n        if (GLB.isRoomOwner) {\n            clearInterval(this.scheduleFireID);\n        }\n    },\n\n    scheduleFire: function() {\n        if (GLB.isRoomOwner) {\n            console.log(\"fire\")\n            clearInterval(this.scheduleFireID);\n            this.scheduleFireID = setInterval(function() {\n                if (Game.GameManager.gameState === GameState.Over) {\n                    clearInterval(this.scheduleFireID);\n                    return;\n                }\n                var data = [];\n                for (var j = 0; j < Game.PlayerManager.players.length; j++) {\n                    var playerScript = Game.PlayerManager.players[j].getComponent(\"player\");\n                    if (playerScript) {\n                        var worldPos = playerScript.firePoint.convertToWorldSpaceAR(cc.v2(0, 0));\n                        var bulletPoint = playerScript.node.parent.convertToNodeSpaceAR(worldPos);\n                        data.push({ playerId: playerScript.userId, bulletPointY: bulletPoint.y });\n                    }\n                }\n                var msg = {\n                    action: GLB.PLAYER_FIRE_EVENT,\n                    data: data\n                };\n                Game.GameManager.sendEventEx(msg);\n            }.bind(this), Game.fireInterval);\n        }\n    },\n\n    spawnBullet: function(hostPlayer, bulletPointY) {\n        var bulletCnt = Game.GameManager.curRound > 3 ? 3 : Game.GameManager.curRound;\n        for (var i = 0; i < bulletCnt; i++) {\n            var bulletObj = null;\n            if (hostPlayer.camp === Camp.Enemy) {\n                bulletObj = this.enemyBulletPool.get()\n                if (!bulletObj) {\n                    bulletObj = cc.instantiate(this.enemyBulletPrefab);\n                }\n            } else {\n                bulletObj = this.friendBulletPool.get()\n                if (!bulletObj) {\n                    bulletObj = cc.instantiate(this.friendBulletPrefab);\n                }\n            }\n            if (bulletObj) {\n                var bulletScript = bulletObj.getComponent('bullet');\n                if (bulletScript) {\n                    bulletScript.init(hostPlayer, i + 1, bulletCnt, bulletPointY, this.bulletId);\n                    this.bulletId++;\n                }\n            }\n        }\n    },\n\n    recycleBullet: function(bulletScript) {\n        if (bulletScript.hostPlayer.camp === Camp.Enemy) {\n            this.enemyBulletPool.put(bulletScript.node);\n        } else {\n            this.friendBulletPool.put(bulletScript.node);\n        }\n    },\n\n    onDestroy: function() {\n        clientEvent.off(clientEvent.eventType.roundStart, this.scheduleFire, this);\n        clientEvent.off(clientEvent.eventType.roundOver, this.clearScheduleFire, this);\n        clientEvent.off(clientEvent.eventType.gameOver, this.clearScheduleFire, this);\n\n    }\n});\n"]}