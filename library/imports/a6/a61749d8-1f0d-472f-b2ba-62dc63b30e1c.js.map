{"version":3,"sources":["../../../../../assets/common/script/assets/common/script/uiMatching2v2Ver.js"],"names":["uiPanel","require","mvs","GLB","cc","Class","extends","properties","playerIcons","Node","onLoad","_super","nodeDict","on","leaveRoom","clientEvent","eventType","joinRoomResponse","joinRoomNotify","leaveRoomResponse","leaveRoomNotify","joinOverResponse","joinRandomRoom","result","matchType","RANDOM_MATCH","engine","MAX_PLAYER_COUNT","console","log","PROPERTY_MATCH","matchinfo","MatchInfo","maxPlayer","mode","canWatch","tags","tagsInfo","joinRoomWithProperties","startGame","director","loadScene","data","status","roomInfo","roomID","roomId","playerIcon","roomUserInfoList","j","length","getComponent","userInfo","setData","i","playerIds","playerId","push","warn","joinOver","playerUserIds","JSON","stringify","roomUserInfo","uiFunc","closeUI","node","name","destroy","leaveRoomInfo","userId","init","leaveRoomRsp","joinOverRsp","notifyGameStart","isRoomOwner","msg","action","GAME_START_EVENT","userIds","Game","GameManager","sendEventEx","onDestroy","off"],"mappings":";;;;;;AAAA,IAAIA,UAAUC,QAAQ,SAAR,CAAd;AACA,IAAIC,MAAMD,QAAQ,SAAR,CAAV;AACA,IAAIE,MAAMF,QAAQ,KAAR,CAAV;AACAG,GAAGC,KAAH,CAAS;AACLC,aAASN,OADJ;AAELO,gBAAY;AACRC,qBAAa,CAACJ,GAAGK,IAAJ;AADL,KAFP;;AAMLC,UANK,oBAMI;AACL,aAAKC,MAAL;AACA,aAAKC,QAAL,CAAc,MAAd,EAAsBC,EAAtB,CAAyB,OAAzB,EAAkC,KAAKC,SAAvC,EAAkD,IAAlD;;AAEAC,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBC,gBAArC,EAAuD,KAAKA,gBAA5D,EAA8E,IAA9E;AACAF,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBE,cAArC,EAAqD,KAAKA,cAA1D,EAA0E,IAA1E;AACAH,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBG,iBAArC,EAAwD,KAAKA,iBAA7D,EAAgF,IAAhF;AACAJ,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBI,eAArC,EAAsD,KAAKA,eAA3D,EAA4E,IAA5E;AACAL,oBAAYF,EAAZ,CAAeE,YAAYC,SAAZ,CAAsBK,gBAArC,EAAuD,KAAKA,gBAA5D,EAA8E,IAA9E;AACH,KAfI;;;AAiBLC,oBAAgB,0BAAW;AACvB,YAAIC,SAAS,IAAb;AACA,YAAIpB,IAAIqB,SAAJ,KAAkBrB,IAAIsB,YAA1B,EAAwC;AACpCF,qBAASrB,IAAIwB,MAAJ,CAAWJ,cAAX,CAA0BnB,IAAIwB,gBAA9B,EAAgD,EAAhD,CAAT;AACA,gBAAIJ,WAAW,CAAf,EAAkB;AACdK,wBAAQC,GAAR,CAAY,gBAAgBN,MAA5B;AACH;AACJ,SALD,MAKO,IAAIpB,IAAIqB,SAAJ,KAAkBrB,IAAI2B,cAA1B,EAA0C;AAC7C,gBAAIC,YAAY,IAAI7B,IAAI8B,SAAR,EAAhB;AACAD,sBAAUE,SAAV,GAAsB9B,IAAIwB,gBAA1B;AACAI,sBAAUG,IAAV,GAAiB,CAAjB;AACAH,sBAAUI,QAAV,GAAqB,CAArB;AACAJ,sBAAUK,IAAV,GAAiBjC,IAAIkC,QAArB;AACAd,qBAASrB,IAAIwB,MAAJ,CAAWY,sBAAX,CAAkCP,SAAlC,EAA6C,wBAA7C,CAAT;AACA,gBAAIR,WAAW,CAAf,EAAkB;AACdK,wBAAQC,GAAR,CAAY,gBAAgBN,MAA5B;AACH;AACJ;AACJ,KAnCI;;AAqCLgB,eAAW,qBAAW;AAClBX,gBAAQC,GAAR,CAAY,QAAZ;AACAzB,WAAGoC,QAAH,CAAYC,SAAZ,CAAsB,MAAtB;AACH,KAxCI;;AA0CLxB,sBAAkB,0BAASyB,IAAT,EAAe;AAC7B,YAAIA,KAAKC,MAAL,KAAgB,GAApB,EAAyB;AACrBf,oBAAQC,GAAR,CAAY,qBAAqBa,KAAKC,MAAtC;AACA;AACH,SAHD,MAGO;AACHf,oBAAQC,GAAR,CAAY,QAAZ;AACAD,oBAAQC,GAAR,CAAY,UAAUa,KAAKE,QAAL,CAAcC,MAApC;AACH;AACD1C,YAAI2C,MAAJ,GAAaJ,KAAKE,QAAL,CAAcC,MAA3B;;AAEA,YAAIE,aAAa,IAAjB;AACAnB,gBAAQC,GAAR,CAAY,wBAAZ;AACAD,gBAAQC,GAAR,CAAYa,KAAKM,gBAAjB;AACA,aAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIP,KAAKM,gBAAL,CAAsBE,MAA1C,EAAkDD,GAAlD,EAAuD;AACnDF,yBAAa,KAAKvC,WAAL,CAAiByC,CAAjB,EAAoBE,YAApB,CAAiC,YAAjC,CAAb;AACA,gBAAIJ,cAAc,CAACA,WAAWK,QAA9B,EAAwC;AACpCL,2BAAWM,OAAX,CAAmBX,KAAKM,gBAAL,CAAsBC,CAAtB,CAAnB;AACH;AACJ;;AAED,aAAK,IAAIK,IAAI,CAAb,EAAgBA,IAAI,KAAK9C,WAAL,CAAiB0C,MAArC,EAA6CI,GAA7C,EAAkD;AAC9CP,yBAAa,KAAKvC,WAAL,CAAiB8C,CAAjB,EAAoBH,YAApB,CAAiC,YAAjC,CAAb;AACA,gBAAIJ,cAAc,CAACA,WAAWK,QAA9B,EAAwC;AACpCL,2BAAWM,OAAX,CAAmBlD,IAAIiD,QAAvB;AACA;AACH;AACJ;;AAED,YAAIG,YAAY,EAAhB;AACA,aAAK,IAAID,IAAI,CAAb,EAAgBA,IAAI,KAAK9C,WAAL,CAAiB0C,MAArC,EAA6CI,GAA7C,EAAkD;AAC9CP,yBAAa,KAAKvC,WAAL,CAAiB8C,CAAjB,EAAoBH,YAApB,CAAiC,YAAjC,CAAb;AACA,gBAAIJ,cAAcA,WAAWS,QAAX,KAAwB,CAA1C,EAA6C;AACzCD,0BAAUE,IAAV,CAAeV,WAAWS,QAA1B;AACH;AACJ;;AAED,YAAID,UAAUL,MAAV,IAAoB/C,IAAIwB,gBAA5B,EAA8C;AAC1CC,oBAAQ8B,IAAR,CAAa,eAAeH,SAA5B;AACA,gBAAIhC,SAASrB,IAAIwB,MAAJ,CAAWiC,QAAX,CAAoB,EAApB,CAAb;AACA/B,oBAAQC,GAAR,CAAY,WAAZ;AACA,gBAAIN,WAAW,CAAf,EAAkB;AACdK,wBAAQC,GAAR,CAAY,aAAZ,EAA2BN,MAA3B;AACH;AACDpB,gBAAIyD,aAAJ,GAAoBL,SAApB;AACH;AACJ,KAvFI;;AAyFLrC,oBAAgB,wBAASwB,IAAT,EAAe;AAC3Bd,gBAAQC,GAAR,CAAY,kCAAkCgC,KAAKC,SAAL,CAAepB,KAAKqB,YAApB,CAA9C;AACA,YAAIhB,aAAa,IAAjB;AACA,aAAK,IAAIE,IAAI,CAAb,EAAgBA,IAAI,KAAKzC,WAAL,CAAiB0C,MAArC,EAA6CD,GAA7C,EAAkD;AAC9CF,yBAAa,KAAKvC,WAAL,CAAiByC,CAAjB,EAAoBE,YAApB,CAAiC,YAAjC,CAAb;AACA,gBAAIJ,cAAc,CAACA,WAAWK,QAA9B,EAAwC;AACpCL,2BAAWM,OAAX,CAAmBX,KAAKqB,YAAxB;AACA;AACH;AACJ;AACJ,KAnGI;;AAqGLjD,eAAW,qBAAW;AAClBZ,YAAIwB,MAAJ,CAAWZ,SAAX;AACAkD,eAAOC,OAAP,CAAe,KAAKC,IAAL,CAAUC,IAAzB;AACA,aAAKD,IAAL,CAAUE,OAAV;AACH,KAzGI;;AA2GLhD,qBAAiB,yBAASsB,IAAT,EAAe;AAC5B,YAAIvC,IAAI2C,MAAJ,KAAeJ,KAAK2B,aAAL,CAAmBxB,MAAtC,EAA8C;AAC1C,iBAAK,IAAIS,IAAI,CAAb,EAAgBA,IAAI,KAAK9C,WAAL,CAAiB0C,MAArC,EAA6CI,GAA7C,EAAkD;AAC9C,oBAAIP,aAAa,KAAKvC,WAAL,CAAiB8C,CAAjB,EAAoBH,YAApB,CAAiC,YAAjC,CAAjB;AACA,oBAAIJ,cAAcA,WAAWK,QAAzB,IAAqCL,WAAWS,QAAX,KAAwBd,KAAK2B,aAAL,CAAmBC,MAApF,EAA4F;AACxFvB,+BAAWwB,IAAX;AACA;AACH;AACJ;AACJ;AACJ,KArHI;;AAuHLpD,uBAAmB,2BAASuB,IAAT,EAAe;AAC9B,YAAIA,KAAK8B,YAAL,CAAkB7B,MAAlB,KAA6B,GAAjC,EAAsC;AAClCf,oBAAQC,GAAR,CAAY,QAAZ;AACA,iBAAK,IAAIyB,IAAI,CAAb,EAAgBA,IAAI,KAAK9C,WAAL,CAAiB0C,MAArC,EAA6CI,GAA7C,EAAkD;AAC9C,oBAAIP,aAAa,KAAKvC,WAAL,CAAiB8C,CAAjB,EAAoBH,YAApB,CAAiC,YAAjC,CAAjB;AACA,oBAAIJ,UAAJ,EAAgB;AACZA,+BAAWwB,IAAX;AACA;AACH;AACJ;AACDP,mBAAOC,OAAP,CAAe,KAAKC,IAAL,CAAUC,IAAzB;AACA,iBAAKD,IAAL,CAAUE,OAAV;AACH,SAXD,MAWO;AACHxC,oBAAQC,GAAR,CAAY,QAAZ;AACH;AACJ,KAtII;;AAwILR,sBAAkB,0BAASqB,IAAT,EAAe;AAC7B,YAAIA,KAAK+B,WAAL,CAAiB9B,MAAjB,KAA4B,GAAhC,EAAqC;AACjCf,oBAAQC,GAAR,CAAY,QAAZ;AACA,iBAAK6C,eAAL;AACH,SAHD,MAGO;AACH9C,oBAAQC,GAAR,CAAY,iBAAZ,EAA+Ba,KAAK+B,WAAL,CAAiB9B,MAAhD;AACH;AACJ,KA/II;;AAiJL+B,qBAAiB,2BAAW;AACxBvE,YAAIwE,WAAJ,GAAkB,IAAlB;AACA,YAAIC,MAAM;AACNC,oBAAQ1E,IAAI2E,gBADN;AAENC,qBAAS5E,IAAIyD;AAFP,SAAV;AAIAhC,gBAAQ8B,IAAR,CAAa,uBAAuBvD,IAAIyD,aAAxC;AACAoB,aAAKC,WAAL,CAAiBC,WAAjB,CAA6BN,GAA7B;AACH,KAzJI;;AA2JLO,aA3JK,uBA2JO;AACRpE,oBAAYqE,GAAZ,CAAgBrE,YAAYC,SAAZ,CAAsBC,gBAAtC,EAAwD,KAAKA,gBAA7D,EAA+E,IAA/E;AACAF,oBAAYqE,GAAZ,CAAgBrE,YAAYC,SAAZ,CAAsBE,cAAtC,EAAsD,KAAKA,cAA3D,EAA2E,IAA3E;AACAH,oBAAYqE,GAAZ,CAAgBrE,YAAYC,SAAZ,CAAsBG,iBAAtC,EAAyD,KAAKA,iBAA9D,EAAiF,IAAjF;AACAJ,oBAAYqE,GAAZ,CAAgBrE,YAAYC,SAAZ,CAAsBI,eAAtC,EAAuD,KAAKA,eAA5D,EAA6E,IAA7E;AACAL,oBAAYqE,GAAZ,CAAgBrE,YAAYC,SAAZ,CAAsBK,gBAAtC,EAAwD,KAAKA,gBAA7D,EAA+E,IAA/E;AACH;AAjKI,CAAT","file":"uiMatching2v2Ver.js","sourceRoot":"../../../../../assets/common/script","sourcesContent":["var uiPanel = require(\"uiPanel\");\nvar mvs = require(\"Matchvs\");\nvar GLB = require(\"Glb\");\ncc.Class({\n    extends: uiPanel,\n    properties: {\n        playerIcons: [cc.Node]\n    },\n\n    onLoad() {\n        this._super();\n        this.nodeDict[\"quit\"].on(\"click\", this.leaveRoom, this);\n\n        clientEvent.on(clientEvent.eventType.joinRoomResponse, this.joinRoomResponse, this);\n        clientEvent.on(clientEvent.eventType.joinRoomNotify, this.joinRoomNotify, this);\n        clientEvent.on(clientEvent.eventType.leaveRoomResponse, this.leaveRoomResponse, this);\n        clientEvent.on(clientEvent.eventType.leaveRoomNotify, this.leaveRoomNotify, this);\n        clientEvent.on(clientEvent.eventType.joinOverResponse, this.joinOverResponse, this);\n    },\n\n    joinRandomRoom: function() {\n        var result = null;\n        if (GLB.matchType === GLB.RANDOM_MATCH) {\n            result = mvs.engine.joinRandomRoom(GLB.MAX_PLAYER_COUNT, '');\n            if (result !== 0) {\n                console.log('进入房间失败,错误码:' + result);\n            }\n        } else if (GLB.matchType === GLB.PROPERTY_MATCH) {\n            var matchinfo = new mvs.MatchInfo();\n            matchinfo.maxPlayer = GLB.MAX_PLAYER_COUNT;\n            matchinfo.mode = 0;\n            matchinfo.canWatch = 0;\n            matchinfo.tags = GLB.tagsInfo;\n            result = mvs.engine.joinRoomWithProperties(matchinfo, \"joinRoomWithProperties\");\n            if (result !== 0) {\n                console.log('进入房间失败,错误码:' + result);\n            }\n        }\n    },\n\n    startGame: function() {\n        console.log('游戏即将开始');\n        cc.director.loadScene('game');\n    },\n\n    joinRoomResponse: function(data) {\n        if (data.status !== 200) {\n            console.log('进入房间失败,异步回调错误码: ' + data.status);\n            return;\n        } else {\n            console.log('进入房间成功');\n            console.log('房间号: ' + data.roomInfo.roomID);\n        }\n        GLB.roomId = data.roomInfo.roomID;\n\n        var playerIcon = null;\n        console.log(\"data.roomUserInfoList:\");\n        console.log(data.roomUserInfoList);\n        for (var j = 0; j < data.roomUserInfoList.length; j++) {\n            playerIcon = this.playerIcons[j].getComponent('playerIcon');\n            if (playerIcon && !playerIcon.userInfo) {\n                playerIcon.setData(data.roomUserInfoList[j]);\n            }\n        }\n\n        for (var i = 0; i < this.playerIcons.length; i++) {\n            playerIcon = this.playerIcons[i].getComponent('playerIcon');\n            if (playerIcon && !playerIcon.userInfo) {\n                playerIcon.setData(GLB.userInfo);\n                break;\n            }\n        }\n\n        var playerIds = [];\n        for (var i = 0; i < this.playerIcons.length; i++) {\n            playerIcon = this.playerIcons[i].getComponent('playerIcon');\n            if (playerIcon && playerIcon.playerId !== 0) {\n                playerIds.push(playerIcon.playerId);\n            }\n        }\n\n        if (playerIds.length >= GLB.MAX_PLAYER_COUNT) {\n            console.warn(\"playerIds:\" + playerIds);\n            var result = mvs.engine.joinOver(\"\");\n            console.log(\"发出关闭房间的通知\");\n            if (result !== 0) {\n                console.log(\"关闭房间失败，错误码：\", result);\n            }\n            GLB.playerUserIds = playerIds;\n        }\n    },\n\n    joinRoomNotify: function(data) {\n        console.log(\"joinRoomNotify, roomUserInfo:\" + JSON.stringify(data.roomUserInfo));\n        var playerIcon = null;\n        for (var j = 0; j < this.playerIcons.length; j++) {\n            playerIcon = this.playerIcons[j].getComponent('playerIcon');\n            if (playerIcon && !playerIcon.userInfo) {\n                playerIcon.setData(data.roomUserInfo);\n                break;\n            }\n        }\n    },\n\n    leaveRoom: function() {\n        mvs.engine.leaveRoom();\n        uiFunc.closeUI(this.node.name);\n        this.node.destroy();\n    },\n\n    leaveRoomNotify: function(data) {\n        if (GLB.roomId === data.leaveRoomInfo.roomID) {\n            for (var i = 0; i < this.playerIcons.length; i++) {\n                var playerIcon = this.playerIcons[i].getComponent('playerIcon');\n                if (playerIcon && playerIcon.userInfo && playerIcon.playerId === data.leaveRoomInfo.userId) {\n                    playerIcon.init();\n                    break;\n                }\n            }\n        }\n    },\n\n    leaveRoomResponse: function(data) {\n        if (data.leaveRoomRsp.status === 200) {\n            console.log(\"离开房间成功\");\n            for (var i = 0; i < this.playerIcons.length; i++) {\n                var playerIcon = this.playerIcons[i].getComponent('playerIcon');\n                if (playerIcon) {\n                    playerIcon.init();\n                    break;\n                }\n            }\n            uiFunc.closeUI(this.node.name);\n            this.node.destroy();\n        } else {\n            console.log(\"离开房间失败\");\n        }\n    },\n\n    joinOverResponse: function(data) {\n        if (data.joinOverRsp.status === 200) {\n            console.log(\"关闭房间成功\");\n            this.notifyGameStart();\n        } else {\n            console.log(\"关闭房间失败，回调通知错误码：\", data.joinOverRsp.status);\n        }\n    },\n\n    notifyGameStart: function() {\n        GLB.isRoomOwner = true;\n        var msg = {\n            action: GLB.GAME_START_EVENT,\n            userIds: GLB.playerUserIds\n        };\n        console.warn(\"GLB.playerUserIds:\" + GLB.playerUserIds);\n        Game.GameManager.sendEventEx(msg);\n    },\n\n    onDestroy() {\n        clientEvent.off(clientEvent.eventType.joinRoomResponse, this.joinRoomResponse, this);\n        clientEvent.off(clientEvent.eventType.joinRoomNotify, this.joinRoomNotify, this);\n        clientEvent.off(clientEvent.eventType.leaveRoomResponse, this.leaveRoomResponse, this);\n        clientEvent.off(clientEvent.eventType.leaveRoomNotify, this.leaveRoomNotify, this);\n        clientEvent.off(clientEvent.eventType.joinOverResponse, this.joinOverResponse, this);\n    }\n});\n"]}